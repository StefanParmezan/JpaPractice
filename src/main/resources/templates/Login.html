<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Вход в систему</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; }
    input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    button { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #218838; }
    .message { margin-top: 15px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .nav { text-align: center; margin-top: 20px; }
    .token-display { word-break: break-all; font-size: 12px; margin-top: 10px; }
  </style>
</head>
<body>
<h2>Вход в систему</h2>
<form id="loginForm">
  <div class="form-group">
    <label for="username">Имя пользователя:</label>
    <input type="text" id="username" name="username" required>
  </div>
  <div class="form-group">
    <label for="password">Пароль:</label>
    <input type="password" id="password" name="password" required>
  </div>
  <button type="submit">Войти</button>
</form>

<div id="message"></div>

<div class="nav">
  <a href="http://localhost:8080/register">Нет аккаунта? Зарегистрироваться</a> |
  <a href="orders.html">Перейти к заказам</a>
</div>

<script>
  document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = {
          username: document.getElementById('username').value,
          password: document.getElementById('password').value
      };

      try {
          const response = await fetch('/auth', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(formData)
          });

          const messageDiv = document.getElementById('message');

          if (response.ok) {
              const authData = await response.json();
              messageDiv.innerHTML = `<div class="success">Авторизация успешна! Добро пожаловать, ${authData.username}</div>`;

              // Сохраняем токен в localStorage
              localStorage.setItem('jwtToken', authData.token);
              localStorage.setItem('username', authData.username);

              // Показываем токен (для отладки)
              messageDiv.innerHTML += `<div class="token-display">Токен: ${authData.token}</div>`;

              // Перенаправляем на страницу заказов через 2 секунды
              setTimeout(() => {
                  window.location.href = 'orders.html';
              }, 2000);
          } else {
              const error = await response.text();
              messageDiv.innerHTML = `<div class="error">Ошибка авторизации: ${error}</div>`;
          }
      } catch (error) {
          document.getElementById('message').innerHTML = `<div class="error">Ошибка сети: ${error.message}</div>`;
      }
  });

  // Проверяем, есть ли уже токен
  if (localStorage.getItem('jwtToken')) {
      document.getElementById('message').innerHTML = `<div class="success">Вы уже авторизованы как ${localStorage.getItem('username')}. <a href="orders.html">Перейти к заказам</a></div>`;
  }
</script>
</body>
</html>