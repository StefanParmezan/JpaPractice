<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мой профиль</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background-color: #f8f9fa;
      color: #333;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
    }
    .profile-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 30px;
    }
    .profile-info p {
      margin: 10px 0;
      font-size: 18px;
    }
    .profile-info strong {
      color: #495057;
    }
    .orders-section h2 {
      margin-top: 0;
      color: #28a745;
    }
    .order-item {
      background: #f8f9fa;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 6px 6px 0;
    }
    .order-id {
      font-weight: bold;
      color: #007bff;
    }
    button {
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s;
    }
    button:hover {
      background: #c82333;
    }
    .loading {
      text-align: center;
      color: #6c757d;
      font-style: italic;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }
    .countdown {
      color: #e74c3c;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
  <script>
    // --- COOKIE: УСТАНОВКА ---
    function setCookie(name, value, days = 7) {
        console.log(`[COOKIE] Установка: ${name} = ${value} (на ${days} дней)`);
        const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
        document.cookie = name + '=' + value + '; expires=' + expires + '; path=/';
        console.log(`[COOKIE] После установки document.cookie:`, document.cookie);
    }

    // --- COOKIE: ЧТЕНИЕ ---
    function getCookie(name) {
        console.log(`[COOKIE] Попытка чтения: ${name}`);
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        console.log(`[COOKIE] Все части cookie:`, ca);
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            console.log(`[COOKIE] Проверка части [${i}]: "${c}"`);
            if (c.indexOf(nameEQ) === 0) {
                const value = c.substring(nameEQ.length, c.length);
                console.log(`[COOKIE] Найдено значение для ${name}: "${value}"`);
                return value;
            }
        }
        console.log(`[COOKIE] Значение для ${name} НЕ НАЙДЕНО`);
        return null;
    }

    // --- COOKIE: УДАЛЕНИЕ ---
    function deleteCookie(name) {
        console.log(`[COOKIE] Удаление: ${name}`);
        document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
        console.log(`[COOKIE] После удаления document.cookie:`, document.cookie);
    }

    // --- ЗАПРОС К API ---
    async function makeAuthenticatedRequest(url, options = {}) {
        console.log(`[API] Начало запроса к: ${url}`);
        const token = getCookie('jwtToken');
        if (!token) {
            console.warn(`[API] Токен отсутствует! Запрос к ${url} отменён.`);
            return Promise.reject('No token');
        }

        const defaultOptions = {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        };

        const mergedOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...options.headers
            }
        };

        console.log(`[API] Заголовки запроса:`, mergedOptions.headers);

        try {
            const response = await fetch(url, mergedOptions);
            console.log(`[API] Ответ от ${url}: статус = ${response.status}, ok = ${response.ok}`);
            return response;
        } catch (error) {
            console.error(`[API] Ошибка при запросе к ${url}:`, error);
            return Promise.reject(error);
        }
    }

    // --- РЕДИРЕКТ С ОБРАТНЫМ ОТСЧЁТОМ ---
    function showCountdownAndRedirect() {
        console.log(`[REDIRECT] Инициализация редиректа на /login через 10 секунд`);
        let seconds = 10;
        const contentDiv = document.getElementById('content');
        contentDiv.innerHTML = `
            <div class="error">
                <p>Сессия недействительна или вы не авторизованы.</p>
                <p class="countdown">Переход на страницу входа через <span id="countdown">${seconds}</span> секунд...</p>
            </div>
        `;

        const countdownElement = document.getElementById('countdown');
        const countdownInterval = setInterval(() => {
            seconds--;
            console.log(`[REDIRECT] Осталось секунд: ${seconds}`);
            if (seconds > 0) {
                countdownElement.textContent = seconds;
            } else {
                clearInterval(countdownInterval);
                console.log(`[REDIRECT] Выполняется переход на /login`);
                window.location.href = '/login';
            }
        }, 1000);
    }

    // --- ЗАГРУЗКА ПРОФИЛЯ ---
    async function loadProfileData() {
        console.log(`[PROFILE] Начало загрузки данных профиля`);
        const userId = getCookie('userId');
        if (!userId) {
            console.error(`[PROFILE] userId не найден в cookie`);
            showCountdownAndRedirect();
            return;
        }
        console.log(`[PROFILE] userId из cookie: ${userId}`);

        try {
            const response = await makeAuthenticatedRequest(`/${userId}`);

            // Обработка только для этого запроса
            if (response.status === 401 || response.status === 403) {
                console.warn(`[PROFILE] Получен статус ${response.status} — сессия недействительна`);
                deleteCookie('jwtToken');
                deleteCookie('username');
                deleteCookie('userId');
                showCountdownAndRedirect();
                return;
            }

            if (!response.ok) {
                console.error(`[PROFILE] Запрос завершился с ошибкой: ${response.status}`);
                throw new Error(`HTTP ${response.status}`);
            }

            const profile = await response.json();
            console.log(`[PROFILE] Получены данные профиля:`, profile);

            const formatDate = (dateString) =>
                new Date(dateString).toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

            const ordersHtml = profile.orders && profile.orders.length > 0
                ? profile.orders.map(order => `
                    <div class="order-item">
                        <div><span class="order-id">Заказ #${order.id}</span></div>
                        <div><strong>Статус:</strong> ${order.status}</div>
                        <div><strong>Создан:</strong> ${formatDate(order.createdAt)}</div>
                    </div>
                `).join('')
                : '<p>У вас пока нет заказов.</p>';

            document.getElementById('content').innerHTML = `
                <div class="profile-card">
                    <h2>Мой профиль</h2>
                    <div class="profile-info">
                        <p><strong>ID:</strong> ${profile.id}</p>
                        <p><strong>Имя:</strong> ${profile.name}</p>
                        <p><strong>Email:</strong> ${profile.email}</p>
                    </div>
                </div>

                <div class="orders-section">
                    <h2>Мои заказы (${profile.orders ? profile.orders.length : 0})</h2>
                    ${ordersHtml}
                </div>
            `;
            console.log(`[PROFILE] Данные успешно отображены`);
        } catch (error) {
            console.error(`[PROFILE] Критическая ошибка при загрузке:`, error);
            if (!document.getElementById('countdown')) {
                document.getElementById('content').innerHTML =
                    `<div class="error">Не удалось загрузить профиль. Проверьте консоль.</div>`;
            }
        }
    }

    // --- ВЫХОД ---
    function logout() {
        console.log(`[LOGOUT] Инициализация выхода`);
        deleteCookie('jwtToken');
        deleteCookie('username');
        deleteCookie('userId');
        console.log(`[LOGOUT] Переход на /login`);
        window.location.href = '/login';
    }

    // --- ИНИЦИАЛИЗАЦИЯ СТРАНИЦЫ ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log(`[INIT] DOMContentLoaded — начало инициализации`);
        console.log(`[INIT] Все cookie при загрузке:`, document.cookie);

        const token = getCookie('jwtToken');
        const userId = getCookie('userId');

        console.log(`[INIT] Токен:`, token);
        console.log(`[INIT] userId:`, userId);

        if (!token) {
            console.error(`[INIT] Токен отсутствует — запуск редиректа`);
            showCountdownAndRedirect();
            return;
        }

        if (!userId) {
            console.error(`[INIT] userId отсутствует — запуск редиректа`);
            showCountdownAndRedirect();
            return;
        }

        console.log(`[INIT] Все данные есть — запуск загрузки профиля`);
        loadProfileData();
    });
  </script>
</head>
<body>
<div class="header">
  <h1>Личный кабинет</h1>
  <button onclick="logout()">Выйти</button>
</div>

<div id="content">
  <p class="loading">Загрузка данных профиля...</p>
</div>
</body>
</html>