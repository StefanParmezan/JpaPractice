<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Приватная страница</title>
  <script>
    // --- Вспомогательные функции для cookies ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function deleteCookie(name) {
      document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
    }

    // --- Универсальная функция для авторизованных запросов ---
    async function makeAuthenticatedRequest(url, options = {}) {
      const token = getCookie('jwtToken');

      if (!token) {
        window.location.href = '/login';
        return Promise.reject('No token');
      }

      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      };

      const mergedOptions = {
        ...defaultOptions,
        ...options,
        headers: {
          ...defaultOptions.headers,
          ...options.headers
        }
      };

      try {
        const response = await fetch(url, mergedOptions);

        if (response.status === 401 || response.status === 403) {
          // Токен недействителен — очищаем и редиректим
          deleteCookie('jwtToken');
          deleteCookie('username');
          window.location.href = '/login';
          return Promise.reject('Unauthorized');
        }

        return response;
      } catch (error) {
        console.error('Ошибка запроса:', error);
        return Promise.reject(error);
      }
    }

    // --- Загрузка защищённых данных ---
    async function loadProtectedData() {
      try {
        const response = await makeAuthenticatedRequest('/api/protected-data');
        const data = await response.json();
        document.getElementById('protectedContent').innerHTML =
          `<p>Данные загружены: ${JSON.stringify(data)}</p>`;
      } catch (error) {
        // Ошибка уже обработана в makeAuthenticatedRequest
      }
    }

    // --- Выход из системы ---
    function logout() {
      deleteCookie('jwtToken');
      deleteCookie('username');
      window.location.href = '/login';
    }

    // --- Проверка при загрузке страницы ---
    document.addEventListener('DOMContentLoaded', function() {
      const token = getCookie('jwtToken');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      // Загружаем данные
      loadProtectedData();
    });
  </script>
</head>
<body>
<h1>Приватная страница</h1>
<button onclick="logout()">Выйти</button>
<div id="protectedContent">
  <p>Загрузка защищённых данных...</p>
</div>
</body>
</html>